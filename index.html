<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis - AI Student Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.38.0/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input[type="email"], input[type="password"], input[type="text"], textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e1e1;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: rgba(255, 255, 255, 0.8);
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .auth-toggle {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            margin-top: 20px;
            display: inline-block;
        }

        /* Main App Styles */
        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            gap: 10px;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #666;
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .tab-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        /* Chat Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .ai-message {
            background: #f5f5f5;
            color: #333;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            margin-bottom: 0;
        }

        .chat-input button {
            width: auto;
            padding: 12px 24px;
            margin-bottom: 0;
        }

        /* Photo Upload Styles */
        .photo-upload {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .photo-upload:hover {
            border-color: #667eea;
        }

        .photo-upload.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        /* Notes and Todos Styles */
        .item-list {
            margin-top: 20px;
        }

        .item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .todo-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .todo-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox.checked {
            background: #667eea;
            color: white;
        }

        /* Progress Tracker */
        .progress-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 5px;
            transition: width 0.3s;
        }

        /* Settings */
        .settings-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .nav-tabs {
                padding: 5px;
            }
            
            .nav-tab {
                padding: 8px 15px;
                font-size: 14px;
            }
        }

        .hidden {
            display: none;
        }

        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
        }

        .success {
            color: #27ae60;
            font-size: 14px;
            margin-top: 5px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .image-preview {
            max-width: 300px;
            max-height: 200px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <h1 class="logo">JARVIS</h1>
            <p class="subtitle">Your AI Student Assistant</p>
            
            <form id="authForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                
                <button type="submit" id="authButton">Sign In</button>
                <div id="authError" class="error"></div>
                <div id="authSuccess" class="success"></div>
            </form>
            
            <a href="#" id="authToggle" class="auth-toggle">Need an account? Sign up</a>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <div class="app-header">
                <div class="user-info">
                    <h1 class="logo">JARVIS</h1>
                    <span id="userEmail"></span>
                </div>
                <button id="logoutBtn" class="logout-btn">Logout</button>
            </div>

            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="chat">AI Chat</button>
                <button class="nav-tab" data-tab="math">Math Helper</button>
                <button class="nav-tab" data-tab="summarize">Summarize</button>
                <button class="nav-tab" data-tab="generate">Image Gen</button>
                <button class="nav-tab" data-tab="notes">Notes</button>
                <button class="nav-tab" data-tab="todos">Todos</button>
                <button class="nav-tab" data-tab="reminders">Reminders</button>
                <button class="nav-tab" data-tab="progress">Progress</button>
                <button class="nav-tab" data-tab="settings">Settings</button>
            </nav>

            <!-- Chat Tab -->
            <div id="chatTab" class="tab-content">
                <h2>AI Chat Assistant</h2>
                <div class="chat-container">
                    <div id="chatMessages" class="chat-messages">
                        <div class="ai-message message">
                            Hello! I'm Jarvis, your AI assistant. I can help you with studies, answer questions, and much more. How can I assist you today?
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Ask me anything..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>

            <!-- Math Helper Tab -->
            <div id="mathTab" class="tab-content hidden">
                <h2>Math Helper</h2>
                <p>Upload a photo of your math problem and I'll help you solve it!</p>
                
                <div class="photo-upload" id="mathUpload" onclick="document.getElementById('mathFile').click()">
                    <p>📸 Click or drag to upload math problem photo</p>
                    <input type="file" id="mathFile" accept="image/*" style="display: none;" onchange="handleMathPhoto(this)">
                </div>
                
                <div id="mathPreview"></div>
                <div id="mathSolution"></div>
            </div>

            <!-- Summarize Tab -->
            <div id="summarizeTab" class="tab-content hidden">
                <h2>Text Summarizer</h2>
                <div class="form-group">
                    <label>Text to Summarize:</label>
                    <textarea id="summarizeText" rows="8" placeholder="Paste your text here..."></textarea>
                </div>
                <button onclick="summarizeText()">Summarize</button>
                <div id="summaryResult" style="margin-top: 20px;"></div>
            </div>

            <!-- Image Generator Tab -->
            <div id="generateTab" class="tab-content hidden">
                <h2>AI Image Generator</h2>
                <div class="form-group">
                    <label>Describe the image you want:</label>
                    <input type="text" id="imagePrompt" placeholder="A beautiful sunset over mountains...">
                </div>
                <button onclick="generateImage()">Generate Image</button>
                <div id="generatedImage" style="margin-top: 20px;"></div>
            </div>

            <!-- Notes Tab -->
            <div id="notesTab" class="tab-content hidden">
                <h2>Notes</h2>
                <div class="form-group">
                    <label>Note Title:</label>
                    <input type="text" id="noteTitle" placeholder="Enter note title...">
                </div>
                <div class="form-group">
                    <label>Note Content:</label>
                    <textarea id="noteContent" rows="6" placeholder="Write your note here..."></textarea>
                </div>
                <button onclick="addNote()">Add Note</button>
                <div id="notesList" class="item-list"></div>
            </div>

            <!-- Todos Tab -->
            <div id="todosTab" class="tab-content hidden">
                <h2>Todo List</h2>
                <div class="form-group">
                    <input type="text" id="todoInput" placeholder="Add a new todo..." onkeypress="if(event.key==='Enter') addTodo()">
                    <button onclick="addTodo()">Add Todo</button>
                </div>
                <div id="todosList" class="item-list"></div>
            </div>

            <!-- Reminders Tab -->
            <div id="remindersTab" class="tab-content hidden">
                <h2>Reminders</h2>
                <div class="form-group">
                    <label>Reminder Text:</label>
                    <input type="text" id="reminderText" placeholder="Remember to...">
                </div>
                <div class="form-group">
                    <label>Date & Time:</label>
                    <input type="datetime-local" id="reminderDate">
                </div>
                <button onclick="addReminder()">Add Reminder</button>
                <div id="remindersList" class="item-list"></div>
            </div>

            <!-- Progress Tab -->
            <div id="progressTab" class="tab-content hidden">
                <h2>Study Progress Tracker</h2>
                
                <div class="progress-card">
                    <h3>Overall Progress</h3>
                    <div class="progress-bar">
                        <div id="overallProgress" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <p id="progressText">0% Complete</p>
                </div>

                <div class="form-group">
                    <label>Subject:</label>
                    <input type="text" id="subjectName" placeholder="Math, Science, etc.">
                </div>
                <div class="form-group">
                    <label>Progress (0-100%):</label>
                    <input type="number" id="subjectProgress" min="0" max="100" placeholder="75">
                </div>
                <button onclick="updateProgress()">Update Progress</button>
                
                <div id="subjectProgress" class="item-list"></div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content hidden">
                <h2>Settings</h2>
                
                <div class="settings-section">
                    <h3>Supabase Configuration</h3>
                    <div class="form-group">
                        <label>Supabase URL:</label>
                        <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co">
                    </div>
                    <div class="form-group">
                        <label>Supabase Anon Key:</label>
                        <input type="password" id="supabaseKey" placeholder="Your anon key...">
                    </div>
                    <button onclick="updateSupabaseConfig()">Update Supabase Config</button>
                </div>

                <div class="settings-section">
                    <h3>AI API Configuration</h3>
                    <div class="form-group">
                        <label>OpenAI API Key:</label>
                        <input type="password" id="openaiKey" placeholder="sk-...">
                    </div>
                    <div class="form-group">
                        <label>Claude API Key:</label>
                        <input type="password" id="claudeKey" placeholder="Your Claude API key...">
                    </div>
                    <button onclick="saveApiKeys()">Save API Keys</button>
                </div>

                <div class="settings-section">
                    <h3>Data Management</h3>
                    <button onclick="exportData()">Export All Data</button>
                    <button onclick="clearAllData()" style="background: #e74c3c; margin-left: 10px;">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let supabase = null;
        let currentUser = null;
        let isSignUp = false;
        let chatHistory = [];
        let userNotes = [];
        let userTodos = [];
        let userReminders = [];
        let progressData = {};

        // Setup database tables
        async function setupDatabase() {
            if (!supabase) return;
            
            try {
                // Test connection by trying to get session
                const { data: session, error } = await supabase.auth.getSession();
                console.log('Supabase connection test successful');
                
                // Check if user_data table exists
                const { data, error: tableError } = await supabase
                    .from('user_data')
                    .select('user_id')
                    .limit(1);
                
                if (tableError && tableError.code === 'PGRST116') {
                    console.log('user_data table not found. Please create it in Supabase dashboard.');
                } else {
                    console.log('Database tables ready');
                }
            } catch (error) {
                console.log('Database setup note:', error.message);
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initSupabase();
                setupEventListeners();
                loadSettings();
                checkAuthState();
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Failed to initialize app:', error);
                // Show a basic functional version even if there are errors
                document.getElementById('loginPage').classList.remove('hidden');
            }
        });

        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            // Don't let errors break the app completely
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            // Don't let promise rejections break the app
        });

        // Initialize Supabase
        function initSupabase() {
            const url = localStorage.getItem('supabase_url') || 'https://fbfgeobxinsmphjvchsw.supabase.co';
            const key = localStorage.getItem('supabase_key') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZiZmdlb2J4aW5zbXBoanZjaHN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5ODQxMjAsImV4cCI6MjA3MTU2MDEyMH0.2aGUK51oZSuxw80YwsHmUdmUTfeMd48mzNtVP9TpV4Q';
            
            try {
                supabase = window.supabase.createClient(url, key);
                console.log('Supabase initialized successfully');
                setupDatabase();
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Auth form
            document.getElementById('authForm').addEventListener('submit', handleAuth);
            document.getElementById('authToggle').addEventListener('click', toggleAuthMode);
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // File upload drag and drop
            const mathUpload = document.getElementById('mathUpload');
            mathUpload.addEventListener('dragover', handleDragOver);
            mathUpload.addEventListener('drop', handleDrop);
        }

        // Auth handling
        async function handleAuth(e) {
            e.preventDefault();
            
            if (!supabase) {
                showError('authError', 'Supabase connection failed. Please check your configuration.');
                return;
            }

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const button = document.getElementById('authButton');
            
            button.textContent = 'Loading...';
            button.disabled = true;
            clearMessages();

            try {
                let result;
                if (isSignUp) {
                    result = await supabase.auth.signUp({ 
                        email, 
                        password,
                        options: {
                            data: {
                                display_name: email.split('@')[0]
                            }
                        }
                    });
                    if (result.error) throw result.error;
                    
                    if (result.data.user && !result.data.session) {
                        showSuccess('authSuccess', 'Account created! Please check your email to verify.');
                    } else {
                        currentUser = result.data.user;
                        showMainApp();
                    }
                } else {
                    result = await supabase.auth.signInWithPassword({ email, password });
                    if (result.error) throw result.error;
                    currentUser = result.data.user;
                    showMainApp();
                }
            } catch (error) {
                showError('authError', error.message);
            }
            
            button.textContent = isSignUp ? 'Sign Up' : 'Sign In';
            button.disabled = false;
        }

        function clearMessages() {
            document.getElementById('authError').textContent = '';
            document.getElementById('authSuccess').textContent = '';
        }

        function toggleAuthMode() {
            isSignUp = !isSignUp;
            const button = document.getElementById('authButton');
            const toggle = document.getElementById('authToggle');
            
            if (isSignUp) {
                button.textContent = 'Sign Up';
                toggle.textContent = 'Already have an account? Sign in';
            } else {
                button.textContent = 'Sign In';
                toggle.textContent = 'Need an account? Sign up';
            }
        }

        async function logout() {
            if (supabase) {
                await supabase.auth.signOut();
            }
            currentUser = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        async function checkAuthState() {
            if (!supabase) return;
            
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                showMainApp();
            }
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userEmail').textContent = currentUser?.email || 'User';
            loadUserData();
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // Chat functionality
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            input.value = '';

            // Get AI response
            const response = await getAIResponse(message);
            addMessage(response, 'ai');
            
            // Save to history
            chatHistory.push({ user: message, ai: response, timestamp: new Date() });
            saveUserData();
        }

        function addMessage(content, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.textContent = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function getAIResponse(message) {
            // Check chat history for context
            const context = chatHistory.slice(-5).map(h => `User: ${h.user}\nAI: ${h.ai}`).join('\n');
            
            // Mock AI response - replace with actual API call
            const apiKey = safeGetItem('openai_key') || safeGetItem('claude_key');
            if (!apiKey) {
                return "I'd love to help, but please add your AI API key in settings first!";
            }

            // Simulate AI response
            return new Promise(resolve => {
                setTimeout(() => {
                    const responses = [
                        "That's an interesting question! Let me help you with that.",
                        "I understand. Here's what I think about that topic.",
                        "Great question! Based on my knowledge, I can tell you that...",
                        "Let me break that down for you in a simple way.",
                        "I'm here to help! Here's my take on your question."
                    ];
                    resolve(responses[Math.floor(Math.random() * responses.length)]);
                }, 1000);
            });
        }

        // Math helper
        async function handleMathPhoto(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const preview = document.getElementById('mathPreview');
                    preview.innerHTML = `<img src="${e.target.result}" class="image-preview" alt="Math problem">`;
                    
                    // Mock math solution
                    document.getElementById('mathSolution').innerHTML = `
                        <div class="item">
                            <h3>Solution:</h3>
                            <p>I can see your math problem! To get the actual solution, please configure your AI API key in settings. I'll then analyze the image and provide step-by-step solutions.</p>
                        </div>
                    `;
                };
                
                reader.readAsDataURL(file);
            }
        }

        // Drag and drop handling
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('mathFile').files = files;
                handleMathPhoto({ files });
            }
        }

        // Summarize functionality
        async function summarizeText() {
            const text = document.getElementById('summarizeText').value.trim();
            if (!text) {
                alert('Please enter text to summarize');
                return;
            }

            const result = document.getElementById('summaryResult');
            result.innerHTML = `
                <div class="item">
                    <h3>Summary:</h3>
                    <p>Your text has been processed! To get actual AI summaries, please add your API key in settings. The summary would appear here with key points and main ideas extracted from your text.</p>
                </div>
            `;
        }

        // Image generation
        async function generateImage() {
            const prompt = document.getElementById('imagePrompt').value.trim();
            if (!prompt) {
                alert('Please describe the image you want to generate');
                return;
            }

            const result = document.getElementById('generatedImage');
            result.innerHTML = `
                <div class="item">
                    <h3>Generated Image:</h3>
                    <p>Image generation requested for: "${prompt}"</p>
                    <p>To generate actual images, please configure your AI API key in settings. The generated image would appear here.</p>
                </div>
            `;
        }

        // Notes functionality
        function addNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            
            if (!title || !content) {
                alert('Please fill in both title and content');
                return;
            }

            const note = {
                id: Date.now(),
                title,
                content,
                created: new Date().toLocaleString()
            };

            userNotes.unshift(note);
            displayNotes();
            saveUserData();

            // Clear inputs
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
        }

        function displayNotes() {
            const container = document.getElementById('notesList');
            container.innerHTML = userNotes.map(note => `
                <div class="item">
                    <h4>${note.title}</h4>
                    <p>${note.content}</p>
                    <small>Created: ${note.created}</small>
                    <button class="delete-btn" onclick="deleteNote(${note.id})">Delete</button>
                </div>
            `).join('');
        }

        function deleteNote(id) {
            userNotes = userNotes.filter(note => note.id !== id);
            displayNotes();
            saveUserData();
        }

        // Todos functionality
        function addTodo() {
            const input = document.getElementById('todoInput');
            const text = input.value.trim();
            
            if (!text) {
                alert('Please enter a todo item');
                return;
            }

            const todo = {
                id: Date.now(),
                text,
                completed: false,
                created: new Date().toLocaleString()
            };

            userTodos.unshift(todo);
            displayTodos();
            saveUserData();
            input.value = '';
        }

        function displayTodos() {
            const container = document.getElementById('todosList');
            container.innerHTML = userTodos.map(todo => `
                <div class="item">
                    <div class="todo-item ${todo.completed ? 'completed' : ''}">
                        <div class="checkbox ${todo.completed ? 'checked' : ''}" onclick="toggleTodo(${todo.id})">
                            ${todo.completed ? '✓' : ''}
                        </div>
                        <span>${todo.text}</span>
                        <button class="delete-btn" onclick="deleteTodo(${todo.id})">Delete</button>
                    </div>
                    <small>Created: ${todo.created}</small>
                </div>
            `).join('');
        }

        function toggleTodo(id) {
            const todo = userTodos.find(t => t.id === id);
            if (todo) {
                todo.completed = !todo.completed;
                displayTodos();
                saveUserData();
                updateOverallProgress();
            }
        }

        function deleteTodo(id) {
            userTodos = userTodos.filter(todo => todo.id !== id);
            displayTodos();
            saveUserData();
            updateOverallProgress();
        }

        // Reminders functionality
        function addReminder() {
            const text = document.getElementById('reminderText').value.trim();
            const date = document.getElementById('reminderDate').value;
            
            if (!text || !date) {
                alert('Please fill in both reminder text and date');
                return;
            }

            const reminder = {
                id: Date.now(),
                text,
                date: new Date(date),
                created: new Date().toLocaleString()
            };

            userReminders.unshift(reminder);
            displayReminders();
            saveUserData();

            // Clear inputs
            document.getElementById('reminderText').value = '';
            document.getElementById('reminderDate').value = '';
        }

        function displayReminders() {
            const container = document.getElementById('remindersList');
            const now = new Date();
            
            container.innerHTML = userReminders.map(reminder => {
                const isOverdue = reminder.date < now;
                return `
                    <div class="item" style="${isOverdue ? 'border-left-color: #e74c3c;' : ''}">
                        <h4>${reminder.text} ${isOverdue ? '⚠️ OVERDUE' : ''}</h4>
                        <p>Scheduled: ${reminder.date.toLocaleString()}</p>
                        <small>Created: ${reminder.created}</small>
                        <button class="delete-btn" onclick="deleteReminder(${reminder.id})">Delete</button>
                    </div>
                `;
            }).join('');
        }

        function deleteReminder(id) {
            userReminders = userReminders.filter(reminder => reminder.id !== id);
            displayReminders();
            saveUserData();
        }

        // Progress tracking
        function updateProgress() {
            const subject = document.getElementById('subjectName').value.trim();
            const progress = parseInt(document.getElementById('subjectProgress').value);
            
            if (!subject || isNaN(progress) || progress < 0 || progress > 100) {
                alert('Please enter a valid subject name and progress (0-100)');
                return;
            }

            progressData[subject] = {
                progress,
                lastUpdated: new Date().toLocaleString()
            };

            displayProgress();
            updateOverallProgress();
            saveUserData();

            // Clear inputs
            document.getElementById('subjectName').value = '';
            document.getElementById('subjectProgress').value = '';
        }

        function displayProgress() {
            const container = document.getElementById('subjectProgress');
            container.innerHTML = Object.entries(progressData).map(([subject, data]) => `
                <div class="item">
                    <h4>${subject}</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${data.progress}%; background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                    </div>
                    <p>${data.progress}% Complete</p>
                    <small>Last updated: ${data.lastUpdated}</small>
                    <button class="delete-btn" onclick="deleteProgress('${subject}')">Delete</button>
                </div>
            `).join('');
        }

        function deleteProgress(subject) {
            delete progressData[subject];
            displayProgress();
            updateOverallProgress();
            saveUserData();
        }

        function updateOverallProgress() {
            const subjects = Object.values(progressData);
            const completedTodos = userTodos.filter(t => t.completed).length;
            const totalTodos = userTodos.length;
            
            let overallProgress = 0;
            
            if (subjects.length > 0) {
                const avgSubjectProgress = subjects.reduce((sum, s) => sum + s.progress, 0) / subjects.length;
                overallProgress += avgSubjectProgress * 0.7; // 70% weight for subjects
            }
            
            if (totalTodos > 0) {
                const todoProgress = (completedTodos / totalTodos) * 100;
                overallProgress += todoProgress * 0.3; // 30% weight for todos
            }
            
            overallProgress = Math.round(overallProgress);
            
            document.getElementById('overallProgress').style.width = overallProgress + '%';
            document.getElementById('progressText').textContent = overallProgress + '% Complete';
        }

        // Settings functionality
        function updateSupabaseConfig() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            if (!url || !key) {
                alert('Please enter both URL and key');
                return;
            }

            safeSetItem('supabase_url', url);
            safeSetItem('supabase_key', key);
            
            initSupabase();
            alert('Supabase configuration updated! Please refresh the page.');
        }

        function saveApiKeys() {
            const openaiKey = document.getElementById('openaiKey').value.trim();
            const claudeKey = document.getElementById('claudeKey').value.trim();
            
            if (openaiKey) {
                safeSetItem('openai_key', openaiKey);
            }
            
            if (claudeKey) {
                safeSetItem('claude_key', claudeKey);
            }
            
            alert('API keys saved successfully!');
        }

        function loadSettings() {
            const supabaseUrl = safeGetItem('supabase_url') || 'https://fbfgeobxinsmphjvchsw.supabase.co';
            const supabaseKey = safeGetItem('supabase_key') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZiZmdlb2J4aW5zbXBoanZjaHN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5ODQxMjAsImV4cCI6MjA3MTU2MDEyMH0.2aGUK51oZSuxw80YwsHmUdmUTfeMd48mzNtVP9TpV4Q';
            const openaiKey = safeGetItem('openai_key');
            const claudeKey = safeGetItem('claude_key');
            
            document.getElementById('supabaseUrl').value = supabaseUrl;
            document.getElementById('supabaseKey').value = supabaseKey;
            if (openaiKey) document.getElementById('openaiKey').value = openaiKey;
            if (claudeKey) document.getElementById('claudeKey').value = claudeKey;
        }

        // Data management
        async function saveUserData() {
            const userData = {
                chatHistory,
                userNotes,
                userTodos,
                userReminders,
                progressData,
                lastUpdated: new Date().toISOString()
            };

            // Save to localStorage as backup if available
            safeSetItem('jarvis_data', JSON.stringify(userData));

            // Save to Supabase if available and user is logged in
            if (supabase && currentUser) {
                try {
                    // First, try to insert new record
                    const { data: insertData, error: insertError } = await supabase
                        .from('user_data')
                        .insert({
                            user_id: currentUser.id,
                            data: userData
                        })
                        .select();

                    if (insertError) {
                        // If insert fails (record exists), update instead
                        const { error: updateError } = await supabase
                            .from('user_data')
                            .update({ 
                                data: userData,
                                updated_at: new Date().toISOString()
                            })
                            .eq('user_id', currentUser.id);
                        
                        if (updateError) {
                            console.error('Supabase update error:', updateError);
                        } else {
                            console.log('Data updated in Supabase');
                        }
                    } else {
                        console.log('Data saved to Supabase');
                    }
                } catch (error) {
                    console.error('Failed to save to Supabase:', error);
                }
            }
        }

        async function loadUserData() {
            // Try loading from Supabase first
            if (supabase && currentUser) {
                try {
                    const { data, error } = await supabase
                        .from('user_data')
                        .select('data')
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    if (data && !error) {
                        const userData = data.data;
                        chatHistory = userData.chatHistory || [];
                        userNotes = userData.userNotes || [];
                        userTodos = userData.userTodos || [];
                        userReminders = userData.userReminders || [];
                        progressData = userData.progressData || {};
                        
                        // Convert reminder dates back to Date objects
                        userReminders = userReminders.map(r => ({
                            ...r,
                            date: new Date(r.date)
                        }));
                        
                        // Display loaded data
                        displayNotes();
                        displayTodos();
                        displayReminders();
                        displayProgress();
                        updateOverallProgress();
                        loadChatHistory();
                        console.log('Data loaded from Supabase');
                        return;
                    }
                } catch (error) {
                    console.error('Failed to load from Supabase:', error);
                }
            }

            // Fallback to localStorage
            const stored = safeGetItem('jarvis_data');
            if (stored) {
                try {
                    const userData = JSON.parse(stored);
                    chatHistory = userData.chatHistory || [];
                    userNotes = userData.userNotes || [];
                    userTodos = userData.userTodos || [];
                    userReminders = userData.userReminders || [];
                    progressData = userData.progressData || {};
                    
                    // Convert reminder dates back to Date objects
                    userReminders = userReminders.map(r => ({
                        ...r,
                        date: new Date(r.date)
                    }));
                    
                    displayNotes();
                    displayTodos();
                    displayReminders();
                    displayProgress();
                    updateOverallProgress();
                    loadChatHistory();
                    console.log('Data loaded from localStorage');
                } catch (error) {
                    console.error('Failed to parse stored data:', error);
                }
            }
        }

        function loadChatHistory() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="ai-message message">
                    Hello! I'm Jarvis, your AI assistant. I can help you with studies, answer questions, and much more. How can I assist you today?
                </div>
            `;
            
            chatHistory.forEach(chat => {
                addMessage(chat.user, 'user');
                addMessage(chat.ai, 'ai');
            });
        }

        function exportData() {
            const userData = {
                chatHistory,
                userNotes,
                userTodos,
                userReminders,
                progressData,
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'jarvis-data-export.json';
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                chatHistory = [];
                userNotes = [];
                userTodos = [];
                userReminders = [];
                progressData = {};
                
                safeRemoveItem('jarvis_data');
                
                // Clear displays
                document.getElementById('chatMessages').innerHTML = `
                    <div class="ai-message message">
                        Hello! I'm Jarvis, your AI assistant. I can help you with studies, answer questions, and much more. How can I assist you today?
                    </div>
                `;
                document.getElementById('notesList').innerHTML = '';
                document.getElementById('todosList').innerHTML = '';
                document.getElementById('remindersList').innerHTML = '';
                document.getElementById('subjectProgress').innerHTML = '';
                updateOverallProgress();
                
                alert('All data cleared successfully!');
            }
        }

        // Utility functions
        function showError(elementId, message) {
            document.getElementById(elementId).textContent = message;
            setTimeout(() => {
                document.getElementById(elementId).textContent = '';
            }, 5000);
        }

        function showSuccess(elementId, message) {
            document.getElementById(elementId).textContent = message;
            setTimeout(() => {
                document.getElementById(elementId).textContent = '';
            }, 5000);
        }

        // Auto-save every 30 seconds
        setInterval(() => {
            if (currentUser && (chatHistory.length > 0 || userNotes.length > 0 || userTodos.length > 0)) {
                saveUserData();
            }
        }, 30000);

        // Check for overdue reminders every minute
        setInterval(() => {
            if (userReminders.length > 0) {
                const now = new Date();
                const overdue = userReminders.filter(r => r.date <= now);
                if (overdue.length > 0) {
                    displayReminders(); // Refresh display to show overdue status
                }
            }
        }, 60000);
    </script>
</body>
</html>